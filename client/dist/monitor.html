<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ†æ­¥éª¤ç”Ÿæˆ - APIè°ƒç”¨ç›‘æ§</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn:hover {
            background: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }
        
        .btn.secondary {
            background: #2196F3;
        }
        
        .btn.secondary:hover {
            background: #1976D2;
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
        }
        
        .btn.danger {
            background: #f44336;
        }
        
        .btn.danger:hover {
            background: #d32f2f;
            box-shadow: 0 4px 12px rgba(244, 67, 54, 0.3);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .stat-label {
            color: #666;
            font-size: 1.1em;
        }
        
        .stat-success .stat-number { color: #4CAF50; }
        .stat-error .stat-number { color: #f44336; }
        .stat-total .stat-number { color: #2196F3; }
        .stat-time .stat-number { color: #FF9800; }
        
        .calls-section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .section-title {
            font-size: 1.5em;
            margin-bottom: 20px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .call-item {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 15px;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .call-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .call-header {
            background: #f8f9fa;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        
        .call-title {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .call-status {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9em;
        }
        
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 500;
        }
        
        .status-success {
            background: #e8f5e8;
            color: #2e7d32;
        }
        
        .status-error {
            background: #ffebee;
            color: #c62828;
        }
        
        .status-pending {
            background: #fff3e0;
            color: #ef6c00;
        }
        
        .call-details {
            padding: 20px;
            background: white;
            display: none;
        }
        
        .call-details.expanded {
            display: block;
        }
        
        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .detail-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
        }
        
        .detail-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: #555;
        }
        
        .env-var {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #e0e0e0;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        
        .env-var:last-child {
            border-bottom: none;
        }
        
        .env-key {
            font-weight: 600;
            color: #666;
        }
        
        .env-value {
            color: #333;
            word-break: break-all;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        
        .empty-state h3 {
            margin-bottom: 10px;
            color: #999;
        }
        
        .refresh-indicator {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .auto-refresh {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-left: auto;
        }
        
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 24px;
            background: #ccc;
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .toggle-switch.active {
            background: #4CAF50;
        }
        
        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }
        
        .toggle-switch.active .toggle-slider {
            transform: translateX(26px);
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
            
            .controls {
                justify-content: center;
            }
            
            .call-header {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }
            
            .detail-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ” APIè°ƒç”¨ç›‘æ§</h1>
            <p>å®æ—¶ç›‘æ§åˆ†æ­¥éª¤æµ‹è¯•ç”¨ä¾‹ç”Ÿæˆè¿‡ç¨‹ä¸­çš„APIè°ƒç”¨å’Œç¯å¢ƒå˜é‡ä½¿ç”¨æƒ…å†µ</p>
        </div>
        
        <div class="controls">
            <button class="btn" onclick="refreshData()">
                <span>ğŸ”„</span> åˆ·æ–°æ•°æ®
            </button>
            <button class="btn secondary" onclick="checkEnvConfig()">
                <span>âš™ï¸</span> æ£€æŸ¥é…ç½®
            </button>
            <button class="btn danger" onclick="clearData()">
                <span>ğŸ§¹</span> æ¸…é™¤æ•°æ®
            </button>
            <div class="auto-refresh">
                <span>è‡ªåŠ¨åˆ·æ–°</span>
                <div class="toggle-switch" id="autoRefreshToggle" onclick="toggleAutoRefresh()">
                    <div class="toggle-slider"></div>
                </div>
            </div>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card stat-total">
                <div class="stat-number" id="totalCalls">0</div>
                <div class="stat-label">æ€»è°ƒç”¨æ¬¡æ•°</div>
            </div>
            <div class="stat-card stat-success">
                <div class="stat-number" id="successCalls">0</div>
                <div class="stat-label">æˆåŠŸè°ƒç”¨</div>
            </div>
            <div class="stat-card stat-error">
                <div class="stat-number" id="errorCalls">0</div>
                <div class="stat-label">å¤±è´¥è°ƒç”¨</div>
            </div>
            <div class="stat-card stat-time">
                <div class="stat-number" id="avgDuration">0ms</div>
                <div class="stat-label">å¹³å‡è€—æ—¶</div>
            </div>
        </div>
        
        <div class="calls-section">
            <div class="section-title">
                <span>ğŸ“‹</span> APIè°ƒç”¨è®°å½•
                <div class="auto-refresh" style="margin-left: auto;">
                    <span id="lastUpdate">ä»æœªæ›´æ–°</span>
                    <div class="refresh-indicator" id="refreshIndicator" style="display: none;"></div>
                </div>
            </div>
            <div id="callsList">
                <div class="loading">æ­£åœ¨åŠ è½½æ•°æ®...</div>
            </div>
        </div>
    </div>
    
    <script>
        let autoRefreshInterval = null;
        let isAutoRefresh = false;
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            refreshData();
        });
        
        // åˆ·æ–°æ•°æ®
        async function refreshData() {
            showRefreshIndicator(true);
            try {
                const response = await fetch('/api/monitor/data');
                const data = await response.json();
                updateDisplay(data);
                updateLastUpdateTime();
            } catch (error) {
                console.error('è·å–ç›‘æ§æ•°æ®å¤±è´¥:', error);
                showError('è·å–ç›‘æ§æ•°æ®å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨è¿æ¥');
            } finally {
                showRefreshIndicator(false);
            }
        }
        
        // æ›´æ–°æ˜¾ç¤º
        function updateDisplay(data) {
            updateStats(data.stats);
            updateCallsList(data.calls);
        }
        
        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats(stats) {
            document.getElementById('totalCalls').textContent = stats.totalCalls || 0;
            document.getElementById('successCalls').textContent = stats.successCalls || 0;
            document.getElementById('errorCalls').textContent = stats.failedCalls || 0;
            document.getElementById('avgDuration').textContent = (stats.avgDuration || 0) + 'ms';
        }
        
        // æ›´æ–°è°ƒç”¨åˆ—è¡¨
        function updateCallsList(calls) {
            const container = document.getElementById('callsList');
            
            if (!calls || calls.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>æš‚æ— APIè°ƒç”¨è®°å½•</h3>
                        <p>å¼€å§‹ä½¿ç”¨åˆ†æ­¥éª¤ç”ŸæˆåŠŸèƒ½åï¼Œè¿™é‡Œå°†æ˜¾ç¤ºAPIè°ƒç”¨ä¿¡æ¯</p>
                    </div>
                `;
                return;
            }
            
            // æŒ‰æ—¶é—´å€’åºæ’åˆ—
            const sortedCalls = calls.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            container.innerHTML = sortedCalls.map(call => createCallItem(call)).join('');
        }
        
        // åˆ›å»ºè°ƒç”¨é¡¹
        function createCallItem(call) {
            const statusClass = call.status === 'started' ? 'pending' : 
                              call.success ? 'success' : 'error';
            const statusText = call.status === 'started' ? 'è¿›è¡Œä¸­' : 
                             call.success ? 'æˆåŠŸ' : 'å¤±è´¥';
            const statusIcon = call.status === 'started' ? 'â³' : 
                             call.success ? 'âœ…' : 'âŒ';
            
            const duration = call.duration ? `${call.duration}ms` : '-';
            const timestamp = new Date(call.timestamp).toLocaleString();
            
            return `
                <div class="call-item">
                    <div class="call-header" onclick="toggleCallDetails(${call.id})">
                        <div class="call-title">
                            <span>${statusIcon}</span>
                            <span>${call.stepName}</span>
                            <span style="color: #666; font-size: 0.9em;">(${call.apiProvider.toUpperCase()})</span>
                        </div>
                        <div class="call-status">
                            <span class="status-badge status-${statusClass}">${statusText}</span>
                            <span style="color: #666;">${duration}</span>
                            <span style="color: #999; font-size: 0.8em;">${timestamp}</span>
                        </div>
                    </div>
                    <div class="call-details" id="details-${call.id}">
                        ${createCallDetails(call)}
                    </div>
                </div>
            `;
        }
        
        // åˆ›å»ºè°ƒç”¨è¯¦æƒ…
        function createCallDetails(call) {
            const envVarsHtml = Object.entries(call.envVars)
                .filter(([key, value]) => key !== 'purpose' && key !== 'stepType')
                .map(([key, value]) => {
                    const displayValue = value || 'æœªé…ç½®';
                    return `<div class="env-var"><span class="env-key">${key}</span><span class="env-value">${displayValue}</span></div>`;
                })
                .join('');
            
            return `
                <div class="detail-grid">
                    <div class="detail-section">
                        <div class="detail-title">ğŸ“‹ åŸºæœ¬ä¿¡æ¯</div>
                        <div class="env-var">
                            <span class="env-key">æ­¥éª¤</span>
                            <span class="env-value">${call.stepName}</span>
                        </div>
                        <div class="env-var">
                            <span class="env-key">APIæä¾›å•†</span>
                            <span class="env-value">${call.apiProvider.toUpperCase()}</span>
                        </div>
                        <div class="env-var">
                            <span class="env-key">é…ç½®ç±»å‹</span>
                            <span class="env-value">${call.envVars.purpose || '-'}</span>
                        </div>
                        <div class="env-var">
                            <span class="env-key">è°ƒç”¨æ—¶é—´</span>
                            <span class="env-value">${new Date(call.timestamp).toLocaleString()}</span>
                        </div>
                        ${call.duration ? `
                        <div class="env-var">
                            <span class="env-key">è€—æ—¶</span>
                            <span class="env-value">${call.duration}ms</span>
                        </div>
                        ` : ''}
                        ${call.error ? `
                        <div class="env-var">
                            <span class="env-key">é”™è¯¯ä¿¡æ¯</span>
                            <span class="env-value" style="color: #f44336;">${call.error}</span>
                        </div>
                        ` : ''}
                    </div>
                    <div class="detail-section">
                        <div class="detail-title">ğŸ”‘ ç¯å¢ƒå˜é‡é…ç½®</div>
                        ${envVarsHtml}
                    </div>
                </div>
            `;
        }
        
        // åˆ‡æ¢è°ƒç”¨è¯¦æƒ…æ˜¾ç¤º
        function toggleCallDetails(callId) {
            const details = document.getElementById(`details-${callId}`);
            details.classList.toggle('expanded');
        }
        
        // æ£€æŸ¥ç¯å¢ƒå˜é‡é…ç½®
        async function checkEnvConfig() {
            try {
                const response = await fetch('/api/monitor/env-check');
                const configs = await response.json();
                
                let message = 'ç¯å¢ƒå˜é‡é…ç½®æ£€æŸ¥ç»“æœ:\n\n';
                
                Object.entries(configs).forEach(([step, providers]) => {
                    const stepNames = {
                        'analyze': 'æ­¥éª¤1ï¼šéœ€æ±‚åˆ†æ',
                        'supplement': 'æ­¥éª¤2ï¼šéœ€æ±‚è¡¥å……',
                        'test-points': 'æ­¥éª¤3ï¼šæµ‹è¯•ç‚¹ç”Ÿæˆ',
                        'generate-final': 'æ­¥éª¤4ï¼šæœ€ç»ˆæµ‹è¯•ç”¨ä¾‹ç”Ÿæˆ'
                    };
                    
                    message += `${stepNames[step] || step}:\n`;
                    
                    Object.entries(providers).forEach(([provider, config]) => {
                        message += `  ${provider.toUpperCase()}: ${config.purpose}\n`;
                        
                        Object.entries(config).forEach(([key, value]) => {
                            if (key !== 'purpose' && key !== 'stepType') {
                                const status = value ? 'âœ…' : 'âŒ';
                                message += `    ${status} ${key}\n`;
                            }
                        });
                    });
                    
                    message += '\n';
                });
                
                alert(message);
            } catch (error) {
                alert('æ£€æŸ¥ç¯å¢ƒå˜é‡é…ç½®å¤±è´¥ï¼š' + error.message);
            }
        }
        
        // æ¸…é™¤æ•°æ®
        async function clearData() {
            if (!confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰ç›‘æ§æ•°æ®å—ï¼Ÿ')) {
                return;
            }
            
            try {
                const response = await fetch('/api/monitor/clear', { method: 'POST' });
                const result = await response.json();
                
                if (result.success) {
                    refreshData();
                    alert('ç›‘æ§æ•°æ®å·²æ¸…é™¤');
                } else {
                    alert('æ¸…é™¤æ•°æ®å¤±è´¥');
                }
            } catch (error) {
                alert('æ¸…é™¤æ•°æ®å¤±è´¥ï¼š' + error.message);
            }
        }
        
        // åˆ‡æ¢è‡ªåŠ¨åˆ·æ–°
        function toggleAutoRefresh() {
            const toggle = document.getElementById('autoRefreshToggle');
            isAutoRefresh = !isAutoRefresh;
            
            if (isAutoRefresh) {
                toggle.classList.add('active');
                autoRefreshInterval = setInterval(refreshData, 5000); // æ¯5ç§’åˆ·æ–°
            } else {
                toggle.classList.remove('active');
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
            }
        }
        
        // æ˜¾ç¤ºåˆ·æ–°æŒ‡ç¤ºå™¨
        function showRefreshIndicator(show) {
            const indicator = document.getElementById('refreshIndicator');
            indicator.style.display = show ? 'inline-block' : 'none';
        }
        
        // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´
        function updateLastUpdateTime() {
            const lastUpdate = document.getElementById('lastUpdate');
            lastUpdate.textContent = new Date().toLocaleTimeString();
        }
        
        // æ˜¾ç¤ºé”™è¯¯
        function showError(message) {
            const container = document.getElementById('callsList');
            container.innerHTML = `
                <div class="empty-state">
                    <h3 style="color: #f44336;">âŒ åŠ è½½å¤±è´¥</h3>
                    <p>${message}</p>
                </div>
            `;
        }
    </script>
</body>
</html>