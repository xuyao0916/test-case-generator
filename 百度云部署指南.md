# 百度云服务器部署指南

本指南将帮助您将测试用例生成器项目部署到百度云服务器上。

## 1. 服务器准备

### 1.1 购买和配置服务器
- 登录百度云控制台
- 选择合适的云服务器配置（推荐：2核4G，Ubuntu 20.04 LTS）
- 配置安全组，开放以下端口：
  - 22 (SSH)
  - 80 (HTTP)
  - 443 (HTTPS)
  - 3001 (后端API)
  - 8080 (前端开发服务器，可选)

### 1.2 连接服务器
```bash
ssh root@your_server_ip
```

## 2. 环境搭建

### 2.1 更新系统
```bash
apt update && apt upgrade -y
```

### 2.2 安装 Node.js
```bash
# 安装 Node.js 18.x
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
apt-get install -y nodejs

# 验证安装
node --version
npm --version
```

### 2.3 安装 PM2（进程管理器）
```bash
npm install -g pm2
```

### 2.4 安装 Nginx（可选，用于反向代理）
```bash
apt install -y nginx
```

## 3. 代码部署

### 3.1 克隆项目
```bash
cd /var/www
git clone https://github.com/xuyao0916/test-case-generator.git
cd test-case-generator
```

### 3.2 安装依赖
```bash
# 安装后端依赖
npm install

# 安装前端依赖
cd client
npm install
cd ..
```

### 3.3 配置环境变量
```bash
# 创建 .env 文件
cp .env.example .env
nano .env
```

在 .env 文件中配置：
```
DEEPSEEK_API_KEY=your_deepseek_api_key
PORT=3001
NODE_ENV=production
```

### 3.4 构建前端
```bash
cd client
npm run build
cd ..
```

## 4. 配置 Nginx（推荐）

### 4.1 创建 Nginx 配置
```bash
nano /etc/nginx/sites-available/test-case-generator
```

配置内容：
```nginx
server {
    listen 80;
    server_name your_domain.com;  # 替换为您的域名或IP

    # 前端静态文件
    location / {
        root /var/www/test-case-generator/client/dist;
        try_files $uri $uri/ /index.html;
    }

    # API 代理
    location /api/ {
        proxy_pass http://localhost:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # 下载文件
    location /download/ {
        proxy_pass http://localhost:3001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

### 4.2 启用配置
```bash
ln -s /etc/nginx/sites-available/test-case-generator /etc/nginx/sites-enabled/
nginx -t  # 测试配置
systemctl restart nginx
```

## 5. 启动服务

### 5.1 使用 PM2 启动后端服务
```bash
cd /var/www/test-case-generator
pm2 start server.js --name "test-case-generator"
```

### 5.2 设置 PM2 开机自启
```bash
pm2 startup
pm2 save
```

### 5.3 查看服务状态
```bash
pm2 status
pm2 logs test-case-generator
```

## 6. 域名和 SSL 配置（可选）

### 6.1 配置域名
- 在域名服务商处将域名 A 记录指向服务器 IP
- 更新 Nginx 配置中的 `server_name`

### 6.2 安装 SSL 证书（使用 Let's Encrypt）
```bash
# 安装 Certbot
apt install -y certbot python3-certbot-nginx

# 获取证书
certbot --nginx -d your_domain.com
```

## 7. 常用管理命令

### 7.1 PM2 管理
```bash
pm2 restart test-case-generator  # 重启服务
pm2 stop test-case-generator     # 停止服务
pm2 delete test-case-generator   # 删除服务
pm2 logs test-case-generator     # 查看日志
```

### 7.2 更新代码
```bash
cd /var/www/test-case-generator
git pull origin main
npm install
cd client
npm install
npm run build
cd ..
pm2 restart test-case-generator
```

### 7.3 查看服务状态
```bash
systemctl status nginx
pm2 status
netstat -tlnp | grep :3001
```

## 8. 故障排除

### 8.1 常见问题
1. **端口被占用**：使用 `netstat -tlnp | grep :3001` 检查端口
2. **权限问题**：确保文件权限正确 `chown -R www-data:www-data /var/www/test-case-generator`
3. **API 密钥错误**：检查 `.env` 文件中的 `DEEPSEEK_API_KEY`
4. **内存不足**：监控服务器资源使用情况

### 8.2 日志查看
```bash
# PM2 日志
pm2 logs test-case-generator

# Nginx 日志
tail -f /var/log/nginx/access.log
tail -f /var/log/nginx/error.log

# 系统日志
journalctl -u nginx -f
```

## 9. 安全建议

1. **防火墙配置**：只开放必要端口
2. **定期更新**：保持系统和依赖包更新
3. **备份数据**：定期备份 `history.json` 和 `generated/` 目录
4. **监控服务**：设置服务监控和告警
5. **SSL 证书**：使用 HTTPS 加密传输

## 10. 访问应用

部署完成后，您可以通过以下方式访问：
- HTTP: `http://your_server_ip` 或 `http://your_domain.com`
- HTTPS: `https://your_domain.com`（如果配置了 SSL）

---

**注意**：请将配置中的 `your_server_ip`、`your_domain.com` 和 `your_deepseek_api_key` 替换为实际值。